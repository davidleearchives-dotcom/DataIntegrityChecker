{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Data Verification Dashboard</h2>
            <p class="text-gray-500 text-sm">Compare Source Data with Target Data</p>
        </div>
        <div class="flex gap-3">
            <button onclick="resetDashboard()" class="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                <i class="fas fa-undo mr-2"></i> Reset
            </button>
            <button id="exportBtn" onclick="downloadResult()" class="hidden px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-sm">
                <i class="fas fa-file-excel mr-2"></i> Export Result
            </button>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="uploadSection">
        <!-- Source Column -->
        <div class="flex flex-col space-y-4">
            <!-- Source Upload -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-dashed border-gray-300 hover:border-blue-500 transition-colors group cursor-pointer relative" id="sourceDropZone">
                <div class="text-center pointer-events-none">
                    <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                        <i class="fas fa-database text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-800">Source Data</h3>
                    <p class="text-xs text-gray-500 mb-4">Excel (.xlsx), CSV (.csv) or Text (.txt)</p>
                    <input type="file" id="sourceFile" accept=".xlsx,.csv,.txt" class="hidden" onchange="handleFileSelect('sourceFile', 'source')">
                    <span class="text-sm text-blue-600 font-medium hover:underline">Browse File or Drag & Drop</span>
                    
                    <!-- File Metadata Info -->
                    <div id="sourceMeta" class="mt-4 text-left hidden bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <div class="flex justify-between items-center mb-2 border-b border-blue-200 pb-2">
                            <span class="text-xs text-gray-500 font-bold uppercase tracking-wider">File Info</span>
                            <span id="sourceFilename" class="text-sm text-gray-800 font-semibold truncate max-w-[180px]" title=""></span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">Total Rows</span>
                            <span id="sourceRows" class="text-sm text-blue-600 font-bold animate-pulse">Checking...</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500 block mb-1">Mapped Columns</span>
                            <div id="sourceCols" class="flex flex-wrap gap-1">
                                <!-- Badges injected by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Drag Overlay -->
                <div class="absolute inset-0 bg-blue-50 bg-opacity-90 flex items-center justify-center rounded-xl hidden" id="sourceOverlay">
                    <p class="text-blue-600 font-bold">Drop Source File Here</p>
                </div>
            </div>
            <!-- Duplicate Info (Outside of DropZone) -->
            <div id="sourceDupInfo" class="hidden">
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-xs text-yellow-800 shadow-sm">
                    <p class="font-bold mb-2 flex items-center"><i class="fas fa-exclamation-triangle mr-2 text-yellow-600 text-sm"></i>Duplicates Found (<span id="sourceDupCount">0</span>):</p>
                    <div class="max-h-32 overflow-y-auto border border-yellow-100 bg-white bg-opacity-60 rounded-lg mb-3 shadow-inner">
                        <ul id="sourceDupList" class="list-disc list-inside opacity-90 px-3 py-2 space-y-1"></ul>
                    </div>
                    <label class="flex items-center space-x-3 cursor-pointer select-none bg-yellow-100 bg-opacity-50 p-2 rounded-lg hover:bg-yellow-200 transition-colors">
                        <input type="checkbox" id="sourceIncludeDup" class="form-checkbox h-4 w-4 text-yellow-600 rounded border-yellow-300 focus:ring-yellow-500">
                        <span class="font-medium">Include duplicates in comparison</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Target Column -->
        <div class="flex flex-col space-y-4">
            <!-- Target Upload -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-dashed border-gray-300 hover:border-blue-500 transition-colors group cursor-pointer relative" id="targetDropZone">
                <div class="text-center pointer-events-none">
                    <div class="w-12 h-12 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                        <i class="fas fa-file-medical text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-800">Target Data</h3>
                    <p class="text-xs text-gray-500 mb-4">Excel (.xlsx), CSV (.csv) or Text (.txt)</p>
                    <input type="file" id="targetFile" accept=".xlsx,.csv,.txt" class="hidden" onchange="handleFileSelect('targetFile', 'target')">
                    <span class="text-sm text-blue-600 font-medium hover:underline">Browse File or Drag & Drop</span>
                    
                    <!-- File Metadata Info -->
                    <div id="targetMeta" class="mt-4 text-left hidden bg-red-50 p-3 rounded-lg border border-red-100">
                        <div class="flex justify-between items-center mb-2 border-b border-red-200 pb-2">
                            <span class="text-xs text-gray-500 font-bold uppercase tracking-wider">File Info</span>
                            <span id="targetFilename" class="text-sm text-gray-800 font-semibold truncate max-w-[180px]" title=""></span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">Total Rows</span>
                            <span id="targetRows" class="text-sm text-red-600 font-bold animate-pulse">Checking...</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500 block mb-1">Mapped Columns</span>
                            <div id="targetCols" class="flex flex-wrap gap-1">
                                <!-- Badges injected by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Drag Overlay -->
                <div class="absolute inset-0 bg-red-50 bg-opacity-90 flex items-center justify-center rounded-xl hidden" id="targetOverlay">
                    <p class="text-red-600 font-bold">Drop Target File Here</p>
                </div>
            </div>
            <!-- Duplicate Info (Outside of DropZone) -->
            <div id="targetDupInfo" class="hidden">
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-xs text-yellow-800 shadow-sm">
                    <p class="font-bold mb-2 flex items-center"><i class="fas fa-exclamation-triangle mr-2 text-yellow-600 text-sm"></i>Duplicates Found (<span id="targetDupCount">0</span>):</p>
                    <div class="max-h-32 overflow-y-auto border border-yellow-100 bg-white bg-opacity-60 rounded-lg mb-3 shadow-inner">
                        <ul id="targetDupList" class="list-disc list-inside opacity-90 px-3 py-2 space-y-1"></ul>
                    </div>
                    <label class="flex items-center space-x-3 cursor-pointer select-none bg-yellow-100 bg-opacity-50 p-2 rounded-lg hover:bg-yellow-200 transition-colors">
                        <input type="checkbox" id="targetIncludeDup" class="form-checkbox h-4 w-4 text-yellow-600 rounded border-yellow-300 focus:ring-yellow-500">
                        <span class="font-medium">Include duplicates in comparison</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center" id="compareBtnContainer">
        <button onclick="startComparison()" class="px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
            Start Comparison
        </button>
    </div>

    <!-- Loading / Progress -->
    <div id="loading" class="hidden py-8">
        <div class="max-w-xl mx-auto">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span id="progressMessage">Starting...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-2">
                <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
            </div>
            <div class="text-center text-xs text-gray-500">
                Time Elapsed: <span id="timer">0.0s</span>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden space-y-6">
        <!-- Metric Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-gray-500">
                <p class="text-sm text-gray-500">Comparison Rows (Src / Tgt)</p>
                <h3 class="text-xl font-bold text-gray-800">
                    <span id="statSrcRows">-</span> / <span id="statTgtRows">-</span>
                </h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                <p class="text-sm text-gray-500">Matched</p>
                <h3 class="text-2xl font-bold text-green-600" id="statMatch">-</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
                <p class="text-sm text-gray-500">Mismatched</p>
                <h3 class="text-2xl font-bold text-yellow-600" id="statMismatch">-</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
                <p class="text-sm text-gray-500">Missing (Src/Tgt)</p>
                <h3 class="text-2xl font-bold text-red-600">
                    <span id="statMissingSrc">0</span> / <span id="statMissingTgt">0</span>
                </h3>
            </div>
        </div>

        <!-- Preview Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-semibold text-gray-700">Preview (Mismatches Only)</h3>
                <span class="text-xs text-gray-500">Showing top 100 discrepancies</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100" id="tableHeader">
                        <!-- Dynamic Header -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dynamic Body -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let currentResultFile = "";
    let pollInterval = null;
    let startTime = null;
    let mappingSettings = { source_cols: [], target_cols: [] };

    // Fetch Settings on Load
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await axios.get('/settings');
            if (res.data && res.data.column_mapping) {
                const parsed = JSON.parse(res.data.column_mapping);
                mappingSettings.source_cols = parsed.source_cols || [];
                mappingSettings.target_cols = parsed.target_cols || [];
            }
        } catch (err) {
            console.error("Failed to load settings:", err);
            // Default fallback if needed
        }
    });

    async function handleFileSelect(inputId, type) {
        // type: 'source' or 'target'
        const input = document.getElementById(inputId);
        if (input.files.length === 0) return;

        const file = input.files[0];
        
        // 1. Show Metadata Area
        const metaDiv = document.getElementById(type + 'Meta');
        const filenameSpan = document.getElementById(type + 'Filename');
        const rowsSpan = document.getElementById(type + 'Rows');
        const colsDiv = document.getElementById(type + 'Cols');

        metaDiv.classList.remove('hidden');
        filenameSpan.innerText = file.name;
        filenameSpan.title = file.name;
        
        // 2. Render Mapped Columns Badge
        colsDiv.innerHTML = ''; // Clear previous
        const cols = type === 'source' ? mappingSettings.source_cols : mappingSettings.target_cols;
        const colorClass = type === 'source' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800';
        
        if (cols.length === 0) {
            colsDiv.innerHTML = '<span class="text-xs text-gray-400">No columns mapped</span>';
        } else {
            cols.forEach(col => {
                const badge = document.createElement('span');
                badge.className = `px-2 py-0.5 rounded text-xs font-semibold ${colorClass} border border-opacity-20`;
                badge.innerText = col;
                colsDiv.appendChild(badge);
            });
        }

        // 3. Analyze File (Get Row Count)
        rowsSpan.innerText = "Checking...";
        rowsSpan.classList.add('animate-pulse');
        
        // Reset Duplicate Info
        const dupInfo = document.getElementById(type + 'DupInfo');
        const dupList = document.getElementById(type + 'DupList');
        const dupCount = document.getElementById(type + 'DupCount');
        const dupCheck = document.getElementById(type + 'IncludeDup');
        dupInfo.classList.add('hidden');
        dupList.innerHTML = '';
        if(dupCount) dupCount.innerText = '0';
        dupCheck.checked = false; // Default: Exclude duplicates

        const formData = new FormData();
        formData.append('file', file);
        // Pass relevant columns to API to calculate unique rows based on Key
        formData.append('column_mapping', JSON.stringify({ cols: cols }));

        try {
            const res = await axios.post('/analyze_file', formData);
            const totalRows = res.data.total_rows;
            const uniqueRows = res.data.unique_rows;
            const duplicates = res.data.duplicate_list || [];
            
            // Display: Total (Unique)
            if (uniqueRows < totalRows) {
                rowsSpan.innerHTML = `${totalRows.toLocaleString()} <span class="text-xs text-red-500 font-bold ml-1">(Unique: ${uniqueRows.toLocaleString()})</span>`;
                
                // Show Duplicate Details
                if (duplicates.length > 0) {
                    dupInfo.classList.remove('hidden');
                    if(dupCount) dupCount.innerText = duplicates.length.toLocaleString();
                    
                    duplicates.forEach(dup => {
                        const li = document.createElement('li');
                        li.className = "truncate whitespace-nowrap"; // Keep full text but truncate visually if too long, or use horizontal scroll?
                        // User requested scrollable area. whitespace-nowrap helps horizontal scroll if container allows, or just vertical.
                        // Since we have vertical scroll, let's allow wrapping or just truncate?
                        // "전체 중복되는 데이터를 보여주되 해당 영역내에서 스크롤로 전체 중복데이터를 확인"
                        // This usually means vertical scroll for many items.
                        li.innerText = dup;
                        li.title = dup;
                        dupList.appendChild(li);
                    });
                }
            } else {
                rowsSpan.innerText = totalRows.toLocaleString();
            }
            
        } catch (err) {
            console.error(err);
            rowsSpan.innerText = "Error";
            alert("Failed to analyze file: " + (err.response?.data?.detail || err.message));
        } finally {
            rowsSpan.classList.remove('animate-pulse');
        }
    }

    async function startComparison() {
        const sourceFile = document.getElementById('sourceFile').files[0];
        const targetFile = document.getElementById('targetFile').files[0];

        if (!sourceFile || !targetFile) {
            alert("Please select both files.");
            return;
        }

        // UI Reset
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('resultsSection').classList.add('hidden');
        document.getElementById('compareBtnContainer').classList.add('hidden');
        
        // Progress Reset
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressPercent').innerText = '0%';
        document.getElementById('progressMessage').innerText = 'Initializing...';
        document.getElementById('timer').innerText = '0.0s';

        const formData = new FormData();
        formData.append('source_file', sourceFile);
        formData.append('target_file', targetFile);
        
        // Pass Duplicate Handling Options
        const sourceIncludeDup = document.getElementById('sourceIncludeDup').checked;
        const targetIncludeDup = document.getElementById('targetIncludeDup').checked;
        formData.append('source_include_dup', sourceIncludeDup);
        formData.append('target_include_dup', targetIncludeDup);

        try {
            // Start Task
            const response = await axios.post('/compare', formData);
            const taskId = response.data.task_id;
            
            // Start Polling
            pollProgress(taskId);

        } catch (error) {
            alert("Comparison failed to start: " + (error.response?.data?.detail || error.message));
            document.getElementById('compareBtnContainer').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }
    }

    function pollProgress(taskId) {
        if (pollInterval) clearInterval(pollInterval);
        
        pollInterval = setInterval(async () => {
            try {
                const res = await axios.get(`/status/${taskId}`);
                const data = res.data;
                
                // Update UI
                const percent = data.progress + '%';
                document.getElementById('progressBar').style.width = percent;
                document.getElementById('progressPercent').innerText = percent;
                document.getElementById('progressMessage').innerText = data.message;
                document.getElementById('timer').innerText = data.elapsed.toFixed(1) + 's';

                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    finishComparison(data.result);
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    alert("Task Failed: " + data.error);
                    resetUIState();
                }

            } catch (err) {
                console.error("Polling error", err);
                // If 404, task is gone (likely server restart)
                if (err.response && err.response.status === 404) {
                    clearInterval(pollInterval);
                    // Silent reset, no alert
                    resetUIState();
                }
            }
        }, 500);
    }

    function finishComparison(data) {
        // Update Stats
        if(document.getElementById('statSrcRows')) document.getElementById('statSrcRows').innerText = data.summary.source_rows.toLocaleString();
        if(document.getElementById('statTgtRows')) document.getElementById('statTgtRows').innerText = data.summary.target_rows.toLocaleString();
        
        document.getElementById('statMatch').innerText = data.summary.matched.toLocaleString();
        document.getElementById('statMismatch').innerText = data.summary.mismatched.toLocaleString();
        document.getElementById('statMissingSrc').innerText = data.summary.missing_source.toLocaleString();
        document.getElementById('statMissingTgt').innerText = data.summary.missing_target.toLocaleString();
        
        currentResultFile = data.result_file;
        document.getElementById('exportBtn').classList.remove('hidden');

        // Render Table
        renderTable(data.preview);
        
        document.getElementById('resultsSection').classList.remove('hidden');
        document.getElementById('loading').classList.add('hidden');
        // We keep compare button hidden or show it as "New Comparison"?
        // Let's show Reset button in header mostly.
        // But user might want to run again.
    }

    function resetUIState() {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('compareBtnContainer').classList.remove('hidden');
    }

    function renderTable(data) {
        const thead = document.getElementById('tableHeader');
        const tbody = document.getElementById('tableBody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="100%" class="p-4 text-center">No discrepancies found in preview.</td></tr>';
            return;
        }

        // Headers (Get from first item, excluding internal keys)
        // Internal keys: type, key, status
        const internalKeys = ['type', 'key', 'status'];
        const headers = Object.keys(data[0]).filter(k => !internalKeys.includes(k));
        
        // Add "Source/Target" Column Header
        const trHead = document.createElement('tr');
        const thType = document.createElement('th');
        thType.className = "px-6 py-3 bg-gray-200 w-24";
        thType.innerText = "Type";
        trHead.appendChild(thType);
        
        headers.forEach(h => {
            const th = document.createElement('th');
            th.className = "px-6 py-3";
            th.innerText = h;
            trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        // Rows
        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            const isSource = row.type === 'Source';
            
            // Style: Source (Top) = White/Blueish, Target (Bottom) = Grayish
            // Group them visually: Add border bottom only after Target row
            if (isSource) {
                tr.className = "bg-blue-50"; // Light Blue for Source
            } else {
                tr.className = "bg-gray-50 border-b-2 border-gray-300"; // Gray for Target + Divider
            }

            // Type Cell
            const tdType = document.createElement('td');
            tdType.className = "px-6 py-4 font-bold text-xs uppercase " + (isSource ? "text-blue-700" : "text-gray-600");
            tdType.innerText = row.type;
            tr.appendChild(tdType);

            // Data Cells
            headers.forEach(h => {
                const td = document.createElement('td');
                td.className = "px-6 py-4 text-gray-900 whitespace-nowrap";
                
                // Highlight Logic: Compare with sibling row if possible, or just render
                // But simplified logic: comparison.py doesn't flag diff per cell in preview data yet.
                // However, we can infer diff if Source vs Target values are different?
                // Since we iterate linearly Source -> Target, we can check.
                
                // For now, simple render. 
                // Advanced: If we want to highlight specific cell diffs, we need to know paired value.
                // Since data is [Src, Tgt, Src, Tgt...], 
                // If isSource, we look ahead. If !isSource, we look behind.
                
                let val = row[h] !== null ? row[h] : '';
                let isDiff = false;
                
                if (data.length > index + 1 && isSource) {
                    const nextRow = data[index+1];
                    if (nextRow[h] != val) isDiff = true;
                } else if (index > 0 && !isSource) {
                    const prevRow = data[index-1];
                    if (prevRow[h] != val) isDiff = true;
                }
                
                if (isDiff) {
                    td.classList.add("bg-yellow-100", "font-semibold", "text-red-600");
                }
                
                td.innerText = val;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    function downloadResult() {
        if (currentResultFile) {
            // Append token to URL for authentication
            const token = localStorage.getItem('token');
            window.location.href = `/download/${currentResultFile}?token=${token}`;
        }
    }

    function resetDashboard() {
        location.reload();
    }

    // Drag and Drop Logic
    function setupDragAndDrop(dropZoneId, overlayId, inputId, type) {
        const dropZone = document.getElementById(dropZoneId);
        const overlay = document.getElementById(overlayId);
        const input = document.getElementById(inputId);

        // Click to open file dialog
        dropZone.addEventListener('click', () => input.click());

        // Drag Events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                overlay.classList.remove('hidden');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                overlay.classList.add('hidden');
            }, false);
        });

        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                input.files = files;
                handleFileSelect(inputId, type);
            }
        });
    }

    setupDragAndDrop('sourceDropZone', 'sourceOverlay', 'sourceFile', 'source');
    setupDragAndDrop('targetDropZone', 'targetOverlay', 'targetFile', 'target');
</script>
{% endblock %}
