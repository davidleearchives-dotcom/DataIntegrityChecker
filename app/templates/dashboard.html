{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Data Verification Dashboard</h2>
            <p class="text-gray-500 text-sm">Compare BMS API Data with Red Cross Data</p>
        </div>
        <div class="flex gap-3">
            <button onclick="resetDashboard()" class="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                <i class="fas fa-undo mr-2"></i> Reset
            </button>
            <button id="exportBtn" onclick="downloadResult()" class="hidden px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-sm">
                <i class="fas fa-file-excel mr-2"></i> Export Result
            </button>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="uploadSection">
        <!-- Source Upload -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-dashed border-gray-300 hover:border-blue-500 transition-colors group cursor-pointer relative" id="sourceDropZone">
            <div class="text-center pointer-events-none">
                <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                    <i class="fas fa-database text-xl"></i>
                </div>
                <h3 class="font-semibold text-gray-800">Source: BMS API Data</h3>
                <p class="text-xs text-gray-500 mb-4">Excel (.xlsx) or CSV (.csv)</p>
                <input type="file" id="sourceFile" accept=".xlsx,.csv" class="hidden" onchange="handleFileSelect('sourceFile', 'sourceInfo')">
                <span class="text-sm text-blue-600 font-medium hover:underline">Browse File or Drag & Drop</span>
                <p id="sourceInfo" class="mt-2 text-sm text-green-600 font-medium hidden"></p>
            </div>
            <!-- Drag Overlay -->
            <div class="absolute inset-0 bg-blue-50 bg-opacity-90 flex items-center justify-center rounded-xl hidden" id="sourceOverlay">
                <p class="text-blue-600 font-bold">Drop Source File Here</p>
            </div>
        </div>

        <!-- Target Upload -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-dashed border-gray-300 hover:border-blue-500 transition-colors group cursor-pointer relative" id="targetDropZone">
            <div class="text-center pointer-events-none">
                <div class="w-12 h-12 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                    <i class="fas fa-file-medical text-xl"></i>
                </div>
                <h3 class="font-semibold text-gray-800">Target: Red Cross Data</h3>
                <p class="text-xs text-gray-500 mb-4">Excel (.xlsx) or CSV (.csv)</p>
                <input type="file" id="targetFile" accept=".xlsx,.csv" class="hidden" onchange="handleFileSelect('targetFile', 'targetInfo')">
                <span class="text-sm text-blue-600 font-medium hover:underline">Browse File or Drag & Drop</span>
                <p id="targetInfo" class="mt-2 text-sm text-green-600 font-medium hidden"></p>
            </div>
             <!-- Drag Overlay -->
             <div class="absolute inset-0 bg-red-50 bg-opacity-90 flex items-center justify-center rounded-xl hidden" id="targetOverlay">
                <p class="text-red-600 font-bold">Drop Target File Here</p>
            </div>
        </div>
    </div>

    <div class="text-center" id="compareBtnContainer">
        <button onclick="startComparison()" class="px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
            Start Comparison
        </button>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="hidden text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-500">Processing files... This may take a moment.</p>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden space-y-6">
        <!-- Metric Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-gray-500">
                <p class="text-sm text-gray-500">Total Rows</p>
                <h3 class="text-2xl font-bold text-gray-800" id="statTotal">-</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                <p class="text-sm text-gray-500">Matched</p>
                <h3 class="text-2xl font-bold text-green-600" id="statMatch">-</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
                <p class="text-sm text-gray-500">Mismatched</p>
                <h3 class="text-2xl font-bold text-yellow-600" id="statMismatch">-</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
                <p class="text-sm text-gray-500">Missing (Src/Tgt)</p>
                <h3 class="text-2xl font-bold text-red-600">
                    <span id="statMissingSrc">0</span> / <span id="statMissingTgt">0</span>
                </h3>
            </div>
        </div>

        <!-- Preview Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-semibold text-gray-700">Preview (Mismatches Only)</h3>
                <span class="text-xs text-gray-500">Showing top 100 discrepancies</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100" id="tableHeader">
                        <!-- Dynamic Header -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dynamic Body -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let currentResultFile = "";

    function handleFileSelect(inputId, infoId) {
        const input = document.getElementById(inputId);
        const info = document.getElementById(infoId);
        if (input.files.length > 0) {
            info.innerText = input.files[0].name;
            info.classList.remove('hidden');
        }
    }

    async function startComparison() {
        const sourceFile = document.getElementById('sourceFile').files[0];
        const targetFile = document.getElementById('targetFile').files[0];

        if (!sourceFile || !targetFile) {
            alert("Please select both files.");
            return;
        }

        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('resultsSection').classList.add('hidden');
        document.getElementById('compareBtnContainer').classList.add('hidden');

        const formData = new FormData();
        formData.append('source_file', sourceFile);
        formData.append('target_file', targetFile);

        try {
            const response = await axios.post('/compare', formData);
            const data = response.data;
            
            // Update Stats
            document.getElementById('statTotal').innerText = data.summary.total_rows;
            document.getElementById('statMatch').innerText = data.summary.matched;
            document.getElementById('statMismatch').innerText = data.summary.mismatched;
            document.getElementById('statMissingSrc').innerText = data.summary.missing_source;
            document.getElementById('statMissingTgt').innerText = data.summary.missing_target;
            
            currentResultFile = data.result_file;
            document.getElementById('exportBtn').classList.remove('hidden');

            // Render Table
            renderTable(data.preview);
            
            document.getElementById('resultsSection').classList.remove('hidden');
        } catch (error) {
            alert("Comparison failed: " + (error.response?.data?.detail || error.message));
            document.getElementById('compareBtnContainer').classList.remove('hidden');
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    }

    function renderTable(data) {
        const thead = document.getElementById('tableHeader');
        const tbody = document.getElementById('tableBody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="100%" class="p-4 text-center">No discrepancies found in preview.</td></tr>';
            return;
        }

        // Headers (Get from first item, excluding internal keys)
        // Internal keys: type, key, status
        const internalKeys = ['type', 'key', 'status'];
        const headers = Object.keys(data[0]).filter(k => !internalKeys.includes(k));
        
        // Add "Source/Target" Column Header
        const trHead = document.createElement('tr');
        const thType = document.createElement('th');
        thType.className = "px-6 py-3 bg-gray-200 w-24";
        thType.innerText = "Type";
        trHead.appendChild(thType);
        
        headers.forEach(h => {
            const th = document.createElement('th');
            th.className = "px-6 py-3";
            th.innerText = h;
            trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        // Rows
        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            const isSource = row.type === 'Source';
            
            // Style: Source (Top) = White/Blueish, Target (Bottom) = Grayish
            // Group them visually: Add border bottom only after Target row
            if (isSource) {
                tr.className = "bg-blue-50"; // Light Blue for Source
            } else {
                tr.className = "bg-gray-50 border-b-2 border-gray-300"; // Gray for Target + Divider
            }

            // Type Cell
            const tdType = document.createElement('td');
            tdType.className = "px-6 py-4 font-bold text-xs uppercase " + (isSource ? "text-blue-700" : "text-gray-600");
            tdType.innerText = row.type;
            tr.appendChild(tdType);

            // Data Cells
            headers.forEach(h => {
                const td = document.createElement('td');
                td.className = "px-6 py-4 text-gray-900 whitespace-nowrap";
                
                // Highlight Logic: Compare with sibling row if possible, or just render
                // But simplified logic: comparison.py doesn't flag diff per cell in preview data yet.
                // However, we can infer diff if Source vs Target values are different?
                // Since we iterate linearly Source -> Target, we can check.
                
                // For now, simple render. 
                // Advanced: If we want to highlight specific cell diffs, we need to know paired value.
                // Since data is [Src, Tgt, Src, Tgt...], 
                // If isSource, we look ahead. If !isSource, we look behind.
                
                let val = row[h] !== null ? row[h] : '';
                let isDiff = false;
                
                if (data.length > index + 1 && isSource) {
                    const nextRow = data[index+1];
                    if (nextRow[h] != val) isDiff = true;
                } else if (index > 0 && !isSource) {
                    const prevRow = data[index-1];
                    if (prevRow[h] != val) isDiff = true;
                }
                
                if (isDiff) {
                    td.classList.add("bg-yellow-100", "font-semibold", "text-red-600");
                }
                
                td.innerText = val;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    function downloadResult() {
        if (currentResultFile) {
            // Append token to URL for authentication
            const token = localStorage.getItem('token');
            window.location.href = `/download/${currentResultFile}?token=${token}`;
        }
    }

    function resetDashboard() {
        location.reload();
    }

    // Drag and Drop Logic
    function setupDragAndDrop(dropZoneId, overlayId, inputId, infoId) {
        const dropZone = document.getElementById(dropZoneId);
        const overlay = document.getElementById(overlayId);
        const input = document.getElementById(inputId);
        const info = document.getElementById(infoId);

        // Click to open file dialog
        dropZone.addEventListener('click', () => input.click());

        // Drag Events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                overlay.classList.remove('hidden');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                overlay.classList.add('hidden');
            }, false);
        });

        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                input.files = files;
                handleFileSelect(inputId, infoId);
            }
        });
    }

    setupDragAndDrop('sourceDropZone', 'sourceOverlay', 'sourceFile', 'sourceInfo');
    setupDragAndDrop('targetDropZone', 'targetOverlay', 'targetFile', 'targetInfo');
</script>
{% endblock %}
